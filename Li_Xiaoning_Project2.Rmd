---
title: "Project 2"
author: "Xiaoning Li"
output: 
  word_document:
    #toc: true
date: "2025-11-11"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r include=FALSE}
# Load packages
library(dplyr)
library(lubridate)
library(ggplot2)
library(tidyr)
library(here)
```

```{r include=FALSE}
# Import datasets ------------------------------------------------------------
aq_2018 <- read.csv(here::here("AQ_2018.csv"))
aq_2019 <- read.csv(here::here("AQ_2019.csv"))
aq_2020 <- read.csv(here::here("AQ_2020.csv"))
```

```{r}
# Function to process air quality data
process_aq_data <- function(data) {
  
  # Rename pollutant concentration columns
  data <- data %>%
    rename(
      "Daily Max 8-hour CO Concentration" = "Daily.Max.8.hour.CO.Concentration",
      "Daily Mean PM2.5 Concentration" = "Daily.Mean.PM2.5.Concentration",
      "Daily Max 8-hour Ozone Concentration" = "Daily.Max.8.hour.Ozone.Concentration"
    )
  
  # Format the date variable correctly
  data <- data %>%
    mutate(Date = mdy(Date))
  
  # Calculate daily averages for days with multiple measurements
  data <- data %>%
    group_by(Date) %>%
    summarise(
      "Daily Max 8-hour CO Concentration" = mean(`Daily Max 8-hour CO Concentration`, na.rm = TRUE),
      "Daily Mean PM2.5 Concentration" = mean(`Daily Mean PM2.5 Concentration`, na.rm = TRUE),
      "Daily Max 8-hour Ozone Concentration" = mean(`Daily Max 8-hour Ozone Concentration`, na.rm = TRUE)
    ) %>%
    ungroup()
  
  # Remove any duplicate rows
  data <- data %>%
    distinct()
  
  # Set negative concentrations to zero
  pollutants <- c("Daily Max 8-hour CO Concentration", 
                  "Daily Mean PM2.5 Concentration", 
                  "Daily Max 8-hour Ozone Concentration")
  
  for (pollutant in pollutants) {
    data[[pollutant]] <- ifelse(data[[pollutant]] < 0, 0, data[[pollutant]])
  }
  
  return(data)
}
```


```{r include=FALSE}
# Run the function on all three datasets
processed_aq_2018 <- process_aq_data(aq_2018)
processed_aq_2019 <- process_aq_data(aq_2019)
processed_aq_2020 <- process_aq_data(aq_2020)
```

# Plot 1
```{r, fig.width=8, fig.height=6, dpi=300, fig.align="center"}
# Combine all years for plotting
combined_data <- bind_rows(processed_aq_2018,
                           processed_aq_2019,
                           processed_aq_2020
                           )

# Calculate monthly averages across all years with 95% CI
monthly_summary <- combined_data %>%
  mutate(Month = month(Date, label = TRUE)) %>%
  group_by(Month) %>%
  summarise(
    CO_mean = mean(`Daily Max 8-hour CO Concentration`, na.rm = TRUE),
    CO_sd = sd(`Daily Max 8-hour CO Concentration`, na.rm = TRUE),
    CO_n = n(),
    O3_mean = mean(`Daily Max 8-hour Ozone Concentration`, na.rm = TRUE),
    O3_sd = sd(`Daily Max 8-hour Ozone Concentration`, na.rm = TRUE),
    O3_n = n(),
  ) %>%
  mutate(
    CO_LB = CO_mean - 1.96 * CO_sd / sqrt(CO_n), 
    CO_UB = CO_mean + 1.96 * CO_sd / sqrt(CO_n),
    O3_LB = O3_mean - 1.96 * O3_sd / sqrt(O3_n),
    O3_UB = O3_mean + 1.96 * O3_sd / sqrt(O3_n)
  )

# Reshape data for plotting
plot_data <- monthly_summary %>%
  pivot_longer(
    cols = c(CO_mean, O3_mean),
    names_to = "Pollutant",
    values_to = "Concentration"
  ) %>%
  mutate(
    LB = ifelse(Pollutant == "CO_mean", CO_LB, O3_LB),
    UB = ifelse(Pollutant == "CO_mean", CO_UB, O3_UB),
    Pollutant = ifelse(Pollutant == "CO_mean", "CO", "O3")
  )

# Plot 1
ggplot(plot_data, aes(x = Month, y = Concentration, color = Pollutant, group = Pollutant)) +
  geom_point(size = 3) +
  geom_line(linewidth = 0.7) +
  geom_errorbar(aes(ymin = LB, ymax = UB), 
                width = 0.2, linewidth = 0.8) +
  scale_color_manual(values = c("CO" = "#E69F00", "O3" = "#0072B2")) +
  labs(
    title = "Monthly Average CO and O3 Concentrations (2018-2020)",
    subtitle = "Error bars represent 95% confidence intervals",
    x = "Month",
    y = "Concentration (ppm)",
    color = "Pollutant"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 10),
    legend.position = "right"
  )
```

# Plot 2
```{r, fig.width=8, fig.height=6, dpi=300, fig.align="center"}
# Prepare data for the plot
pm25_data <- combined_data %>%
  mutate(
    Month = month(Date, label = TRUE),
    Year = as.factor(year(Date))
  ) %>%
  group_by(Month, Year) %>%
  summarise(
    PM25_mean = mean(`Daily Mean PM2.5 Concentration`, na.rm = TRUE),
    .groups = "drop"
  )

# Create PM2.5 plot with line and points
ggplot(pm25_data, aes(x = Month, y = PM25_mean, color = Year, group = Year)) +
  geom_line(linewidth = 1.2, alpha = 0.8) +
  geom_point(size = 3) +
  scale_color_manual(values = c("2018" = "#E41A1C", "2019" = "#377EB8", "2020" = "#4DAF4A")) +
  labs(
    title = "Monthly Average PM2.5 Concentrations by Year (2018-2020)",
    x = "Month",
    y = "PM2.5 Concentration (µg/m³)",
    color = "Year"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    legend.position = "right",
    panel.grid.minor = element_blank()
  )
```

The monthly average PM2.5 concentrations in 2018 and 2019 show similar patterns. The levels decrease in spring, rise in summer, decrease again in fall, and increase in winter. In contrast, the pattern in 2020 appears different, even though we only have data from the first four months. The January concentration in 2020 is substantially lower than in the previous two years, and the values increase steadily from January through April, which is the opposite of the pattern observed in 2018 and 2019.
